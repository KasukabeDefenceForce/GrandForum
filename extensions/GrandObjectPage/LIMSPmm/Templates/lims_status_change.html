<h3>Select New Status</h3>

<% 
if (displayAssignees && displayAssignees.length > 0) { 
%>
    <table class="wikitable">
        <thead>
            <tr>
                <th>Assignee</th>
                <th>Status</th>
                <th>Document</th>
                <th>Reviewer</th>
                <th>Comments</th>
            </tr>
        </thead>
        <tbody>
            <% displayAssignees.forEach(function(assignee, index) { %>
                <tr>
                    <td valign="top"><%= assignee.name %></td>
                    <td valign="top">
                        <% 
                        var assigneeId = (assignee.id != undefined) ? assignee.id : assignee; 
                        var currentStatus = displayStatuses[assigneeId]; // Get current status for the assignee
                        %>
                        
                        <% if (isLeaderAllowedToEdit || (me.get('id') == assigneeId && (currentStatus == 'Assigned' || currentStatus == 'Done'))) { %> 
                            <%= HTML.Select(this, 'displayStatuses.' + assigneeId, { 
                                options: 
                                    isLeaderAllowedToEdit 
                                        ? ['New', 'Assigned', 'Done', 'Closed'] 
                                        : ['Assigned', 'Done'] 
                            }) %>
                        <% } else { %> 
                            <%= currentStatus %>
                        <% } %> 
                    </td>
                    <td valign="top" height>
                      <% 
                        var fileObj  = (displayFiles && displayFiles[assigneeId]) || {};
                        var filename = fileObj.filename || '';
                        var toDelete = fileObj.delete || false;
                      %>
                      <% if (isLeaderAllowedToEdit || ( me.get('id') == assigneeId && ( currentStatus == 'Assigned' || currentStatus == 'Done' ) ) ) { %>
                        <% if (currentStatus !== 'Closed') { %>
                        <% if (filename && !toDelete) { %>
                                <%= filename %>
                                  <span class="delete-icon deleteFile" data-assignee="<%= assigneeId %>">Ã—</span>
                           <% } else {%>
                            <%= HTML.File(this, 'displayFiles.' + assigneeId) %>
                        <% } %>
                      <% } %>
                      <% } else { %>
                        <% if (currentStatus !== 'Closed') { %>
                          <span>No document allowed</span>
                        <% } %>
                        <% } %>
                    </td>
                    <td valign="top">
                        <%
                            var selectedReviewerId = displayReviewers[assigneeId] || null;
                            var peopleList = this.project.members.map(function(member) {
                                return { value: member.get('id'), option: member.get('fullName') };
                            });
                            var reviewerMember = _.find(peopleList, function(p) { return p.value == selectedReviewerId; });
                            var reviewerName = reviewerMember ? reviewerMember.option : "Not Assigned";
                        %>
                        <% if (isLeaderAllowedToEdit) { %>
                            <%
                            var reviewerOptions = peopleList.filter(function(person) {
                                return person.value != assigneeId;
                            });
                            %>
                            <%= HTML.Select(this, 'displayReviewers.' + assigneeId + '.id', {
                                options: reviewerOptions
                            }) %>
                        <% } else { %>
                            <%= reviewerName %>
                        <% } %>
                    </td>

                    <td valign="top" height>
                        <% if (isLeaderAllowedToEdit || (me.get('id') == assigneeId && (currentStatus == 'Assigned' || currentStatus == 'Done'))) { %> 
                            <%= HTML.TextArea(this, 'comments.' + assigneeId, {placeholder: "Enter your comments here", style: "height: 75px;width:100%;box-sizing:border-box;margin:0;"}) %>                        <% } %> 
                           
                    </td>
                </tr>
            <% }.bind(this)); %>
        </tbody>
    </table>
<% 
} else { 
%>
    <div>No assignees</div>
<% 
}
%>


<button id="cancelButton">Close</button>
